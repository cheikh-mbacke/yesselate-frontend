'use client';
import { useState, useEffect } from 'react';
import { useEmployesWorkspaceStore } from '@/lib/stores/employesWorkspaceStore';
import { employesApiService, type Employe } from '@/lib/services/employesApiService';
import { FileText, Shield, Calendar, Star, BarChart3, Search, ChevronRight, Eye, Users, Building2, Mail, Phone, AlertTriangle, DollarSign, Briefcase } from 'lucide-react';
import { cn } from '@/lib/utils';
const STATUS_STYLES = { actif: { border: 'border-l-emerald-500', badge: 'bg-emerald-500/20 text-emerald-600' }, conges: { border: 'border-l-blue-500', badge: 'bg-blue-500/20 text-blue-600' }, mission: { border: 'border-l-indigo-500', badge: 'bg-indigo-500/20 text-indigo-600' }, absent: { border: 'border-l-amber-500', badge: 'bg-amber-500/20 text-amber-600' }, inactif: { border: 'border-l-slate-500', badge: 'bg-slate-500/20 text-slate-600' } };
export function EmployesWorkspaceContent() {
  const { tabs, activeTabId, openTab, currentFilter, watchlist, addToWatchlist, removeFromWatchlist } = useEmployesWorkspaceStore();
  const activeTab = tabs.find(t => t.id === activeTabId); const [employes, setEmployes] = useState<Employe[]>([]); const [loading, setLoading] = useState(true); const [searchQuery, setSearchQuery] = useState(''); const [expandedId, setExpandedId] = useState<string | null>(null);
  const queue = activeTab?.data?.queue as string | undefined;
  useEffect(() => { const load = async () => { setLoading(true); try { const filter = { ...currentFilter }; if (queue && queue !== 'all') { if (queue === 'spof') filter.spof = true; else if (queue === 'risk') filter.status = 'risk'; else filter.status = queue; } if (searchQuery) filter.search = searchQuery; const r = await employesApiService.getAll(filter, 'risk', 1, 50); setEmployes(r.data); } catch (e) { console.error(e); } finally { setLoading(false); } }; load(); }, [currentFilter, queue, searchQuery]);
  const handleOpenDetail = (emp: Employe) => openTab({ type: 'detail', id: `detail:${emp.id}`, title: emp.name, icon: 'üë§', data: { employeId: emp.id } });
  if (!activeTab) return <div className="flex items-center justify-center h-64 text-slate-500"><Users className="w-12 h-12 opacity-30" /></div>;
  if (activeTab.type === 'spof') return <PlaceholderView icon={<Shield className="w-12 h-12" />} title="Employ√©s SPOF" />;
  if (activeTab.type === 'absences') return <PlaceholderView icon={<Calendar className="w-12 h-12" />} title="Gestion des absences" />;
  if (activeTab.type === 'evaluations') return <PlaceholderView icon={<Star className="w-12 h-12" />} title="√âvaluations" />;
  if (activeTab.type === 'analytics') return <PlaceholderView icon={<BarChart3 className="w-12 h-12" />} title="Analytics RH" />;
  if (activeTab.type === 'detail') return <PlaceholderView icon={<FileText className="w-12 h-12" />} title="Fiche employ√©" />;
  return (<div className="space-y-4"><div className="flex flex-wrap items-center justify-between gap-4"><div><h2 className="text-lg font-bold">{queue === 'actif' ? 'Actifs' : queue === 'conges' ? 'En cong√©s' : queue === 'mission' ? 'En mission' : queue === 'spof' ? 'SPOF' : 'Tous les employ√©s'}</h2><p className="text-sm text-slate-500">{employes.length} employ√©(s)</p></div><div className="relative"><Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" /><input type="text" value={searchQuery} onChange={e => setSearchQuery(e.target.value)} placeholder="Rechercher..." className="pl-10 pr-4 py-2 w-64 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500/50" /></div></div>{loading ? <div className="space-y-3">{[...Array(5)].map((_, i) => <div key={i} className="h-28 rounded-xl bg-slate-100 dark:bg-slate-800 animate-pulse" />)}</div> : employes.length === 0 ? <div className="py-12 text-center text-slate-500"><Users className="w-12 h-12 mx-auto mb-3 opacity-30" /><p className="font-medium">Aucun employ√© trouv√©</p></div> : <div className="space-y-2">{employes.map(emp => { const style = STATUS_STYLES[emp.status] || STATUS_STYLES.actif; const isExpanded = expandedId === emp.id; return (<div key={emp.id} className={cn("rounded-xl border-l-4 bg-white dark:bg-slate-900/50 border border-slate-200/70 dark:border-slate-800 transition-all hover:shadow-md", style.border, emp.spof && "ring-1 ring-red-500/20")} onClick={() => setExpandedId(isExpanded ? null : emp.id)}><div className="p-4 cursor-pointer"><div className="flex items-start gap-4"><div className="flex-1 min-w-0"><div className="flex items-center gap-2 flex-wrap mb-1"><span className="font-mono text-xs px-2 py-0.5 rounded bg-slate-100 dark:bg-slate-800 text-slate-600">{emp.matricule}</span><span className={cn("text-xs font-medium px-2 py-0.5 rounded", style.badge)}>{employesApiService.getStatusLabel(emp.status)}</span><span className="text-xs px-2 py-0.5 rounded bg-indigo-500/10 text-indigo-600">{emp.contrat}</span>{emp.spof && <span className="text-xs px-2 py-0.5 rounded bg-red-500/20 text-red-600 flex items-center gap-1"><Shield className="w-3 h-3" />SPOF</span>}{emp.riskScore > 50 && <span className="text-xs px-2 py-0.5 rounded bg-amber-500/20 text-amber-600 flex items-center gap-1"><AlertTriangle className="w-3 h-3" />Risque</span>}</div><p className="font-medium text-slate-900 dark:text-slate-100">{emp.name}</p><div className="flex items-center gap-4 mt-2 text-xs text-slate-500"><span className="flex items-center gap-1"><Briefcase className="w-3 h-3" />{emp.poste}</span><span className="flex items-center gap-1"><Building2 className="w-3 h-3" />{emp.bureau}</span>{emp.scoreEvaluation && <span className="flex items-center gap-1"><Star className="w-3 h-3" />{emp.scoreEvaluation.toFixed(1)}/5</span>}</div></div><div className="text-right flex-none"><p className="font-mono font-bold text-teal-600 flex items-center gap-1 justify-end"><DollarSign className="w-4 h-4" />{employesApiService.formatMontant(emp.salaire)}</p><p className="text-xs text-slate-500 mt-1">FCFA/mois</p><div className="flex items-center justify-end gap-2 mt-2"><button onClick={e => { e.stopPropagation(); handleOpenDetail(emp); }} className="p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-700"><Eye className="w-4 h-4 text-slate-400" /></button><ChevronRight className={cn("w-4 h-4 text-slate-400 transition-transform", isExpanded && "rotate-90")} /></div></div></div></div>{isExpanded && <div className="px-4 pb-4 pt-0 border-t border-slate-200/70 dark:border-slate-800"><div className="grid grid-cols-2 md:grid-cols-4 gap-4 py-4"><div><p className="text-xs text-slate-500 mb-1">Email</p><p className="text-sm font-medium">{emp.email || 'N/A'}</p></div><div><p className="text-xs text-slate-500 mb-1">T√©l√©phone</p><p className="text-sm font-medium">{emp.phone || 'N/A'}</p></div><div><p className="text-xs text-slate-500 mb-1">Date embauche</p><p className="text-sm font-medium">{new Date(emp.dateEmbauche).toLocaleDateString('fr-FR')}</p></div><div><p className="text-xs text-slate-500 mb-1">Cong√©s restants</p><p className="text-sm font-medium">{emp.congesRestants} jours</p></div></div><div className="flex flex-wrap gap-1 mb-4">{emp.competences.map(c => <span key={c} className="px-2 py-1 rounded-full bg-teal-500/10 text-teal-600 text-xs">{c}</span>)}</div><button onClick={() => handleOpenDetail(emp)} className="w-full px-4 py-2 rounded-lg bg-teal-500 text-white text-sm font-medium hover:bg-teal-600">Voir la fiche</button></div>}</div>); })}</div>}</div>);
}
function PlaceholderView({ icon, title }: { icon: React.ReactNode; title: string }) { return <div className="flex items-center justify-center h-64 text-slate-500"><div className="text-center"><div className="mx-auto mb-4 opacity-30">{icon}</div><p className="font-semibold">{title}</p><p className="text-xs mt-4 text-slate-400">En cours de d√©veloppement</p></div></div>; }

